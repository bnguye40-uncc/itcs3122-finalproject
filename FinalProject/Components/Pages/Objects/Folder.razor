@inject Blazored.LocalStorage.ILocalStorageService localStorage

<style>
    .folder-items-list {
        padding: 0px;
        margin: 0px 0px 0px 1em;
    }
    
    .folder-item {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
    }
</style>

<span>
    <span class="display @showDisplay">
        <NavLink class="@($"folder {Class}")" @onclick="Expand">
            @Name
        </NavLink>
        <button class="edit-folder-item" @onclick="ToggleEditMode">Edit</button>
    </span>
    <span class="editing @showEditing">
        <input placeholder="Folder Name..." @bind="@newName"/>
        <button @onclick="SetValue">Done</button>
    </span>
    
    <button class="add-bookmark" @onclick="AddBookmark">ABM</button>
    <button class="add-folder" @onclick="AddFolder">AF</button>
</span>

<ul class="@($"folder-items-list {expandFolder}")">
@foreach (var item in Items) {
    <li class="folder-item">
        @if (item.IsFolder == true)
        {
            <div class="subfolder-item-container">
                <input type="checkbox" @bind-value="@item.IsSelected" >
                <Folder Class="@($"selected-{item.IsSelected}")" Name="@item.Name" Description="@item.Description" />
            </div>
        }
        else
        {
            <div class="bookmark-item-container">
                <input type="checkbox" @bind-value="@item.IsSelected" >
                <Bookmark Class="@($"{item.Class} selected-{item.IsSelected}")" Name="@item.Name" Description="@item.Description" DisplayAsFolderItem=true />
            </div>
        }
    </li>
}
</ul>

@code { 
    
    private string showDisplay = "";
    private string showEditing = "hidden";
    private string newName = "";
    private string expandFolder = "";
    private bool isExpanded = true;

    protected override void OnInitialized()
    {
        newName = Name;
    }

    // Expand folder
    private void Expand() {
        if (Class == "root") { return; }
        isExpanded = !isExpanded;
        expandFolder = isExpanded ? "" : "hidden";
    }

    // Add bookmark
    private void AddBookmark() {
        Items.Add(new Bookmark());
    }

    // Add folder
    private void AddFolder() {
        Items.Add(new Folder());
    }

    // Toggle editing
    private void ToggleEditMode() {
        showDisplay = showDisplay == string.Empty ? "hidden" : "";
        showEditing = showEditing == string.Empty ? "hidden" : "";
    }

    private async void SetValue() {
        if (newName != string.Empty) { Name = newName; }
        else { Name = "Untitled"; }
        await localStorage.SetItemAsync(dataKey, this);
        ToggleEditMode();
    }

    public void DeleteSelected() {
        DeleteSelected(Items);
    }

    private void DeleteSelected(List<IFolderItem> folderItems) {
        if (!folderItems.Any()) { return; }

        folderItems.RemoveAll(item => item.IsSelected);
        
        for (int i = 0; i < folderItems.Count; i++) {
            if (folderItems[i].IsFolder) {
                ((Folder)folderItems[i]).DeleteSelected();
            }
        }
    }
    
}

@code {
    private string dataKey = "";

    protected override async Task OnInitializedAsync()
    {
        dataKey = $"Folder:{Name}";
        var name = await localStorage.GetItemAsync<Folder>(dataKey);
    }
}